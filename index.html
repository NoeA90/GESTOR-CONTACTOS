<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recuperación • Activos vs No Activos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#131a24;
      --accent:#9aff5c;
      --accent-soft:#c8ff9b;
      --muted:#9aa5b7;
      --border:#1c2533;
      --danger:#ff6b6b;
      --ok:#3bff9a;
      --warn:#ffd166;
    }
    *{box-sizing:border-box;font-family:Inter,Roboto,Arial}
    body{margin:0;padding:26px;min-height:100vh;background:var(--bg);color:white;}
    h1{margin:0 0 15px 0;font-size:22px;font-weight:600;}
    .card{
      background:var(--card);padding:22px;border-radius:14px;border:1px solid var(--border);
      box-shadow:0 0 20px #0004;margin-bottom:20px;
    }
    .section-title{font-size:14px;font-weight:700;margin-bottom:8px;color:var(--accent-soft);}
    .boxgroup{display:flex;gap:20px;flex-wrap:wrap;}
    .box{
      flex:1;background:#0f141d;padding:14px;border-radius:12px;border:1px solid #1b2230;min-width:260px;
    }
    input[type=file]{
      width:100%;padding:12px;background:#0d131d;border:1px dashed #2a3647;border-radius:10px;
      color:var(--muted);cursor:pointer;
    }

    .btn-main{
      width:100%;padding:14px;font-size:16px;font-weight:700;background:var(--accent);border:none;border-radius:10px;
      margin-top:18px;cursor:pointer;color:#121715;
    }
    .btn-small{
      padding:8px 14px;font-size:13px;font-weight:700;background:#c7ffe6;color:#021d16;border:none;border-radius:8px;cursor:pointer;
    }
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn-ghost{
      padding:10px 12px;font-size:13px;font-weight:700;background:#0d131d;color:#dbe7ff;border:1px solid #233047;border-radius:10px;
      cursor:pointer;
    }
    .btn-ghost.active{border-color:var(--accent);box-shadow:0 0 0 2px #9aff5c22 inset;}
    .summary{
      margin-top:16px;padding:12px;border-radius:10px;background:#0d131d;border:1px solid #1c2533;color:var(--muted);font-size:14px;
      display:flex;flex-direction:column;gap:6px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;
      border:1px solid #223044;background:#0c111a;color:#e8f1ff;
    }
    .pill.ok{border-color:#1f5d3d;background:#0b1a12;color:var(--ok);}
    .pill.bad{border-color:#5d1f1f;background:#1a0b0b;color:var(--danger);}
    .pill.warn{border-color:#5d4a1f;background:#1a140b;color:var(--warn);}

    table{
      width:100%;margin-top:14px;border-collapse:collapse;background:#0d131d;border-radius:12px;overflow:hidden;border:1px solid #1c2533;
    }
    th,td{padding:10px;border-bottom:1px solid #1c2533;font-size:13px;}
    th{background:#16202c;font-weight:700;color:var(--accent-soft);}
    tr:hover td{background:#141c27;}
    .muted{color:var(--muted);font-size:13px;margin-top:10px}
    .hint{color:#b9c7dd;font-size:13px;line-height:1.4}
    .kpi-row{display:flex;gap:10px;flex-wrap:wrap}
    .kpi{
      flex:1;min-width:220px;background:#0f141d;border:1px solid #1b2230;border-radius:12px;padding:12px;
    }
    .kpi .k{color:var(--muted);font-size:12px;font-weight:700}
    .kpi .v{font-size:20px;font-weight:900;margin-top:6px}
    .toast{
      position:fixed;right:20px;bottom:20px;background:#16202c;padding:12px 16px;border-radius:10px;opacity:0;transform:translateY(20px);
      pointer-events:none;transition:.25s;display:flex;gap:10px;align-items:center;border:1px solid #2a3647;max-width:520px;
    }
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #44546a;border-top-color:var(--accent);animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    code{background:#0b1220;border:1px solid #1d2a3d;padding:2px 6px;border-radius:8px;color:#d7e6ff}

    @media (max-width: 820px){
      body{padding:16px}
    }
  </style>
</head>
<body>

<h1>Recuperación • Activos vs No Activos</h1>

<div class="card">
  <div class="section-title">Archivos CSV</div>

  <div class="boxgroup">
    <div class="box">
      <div class="section-title">Cargas del mes (CSV)</div>
      <input type="file" id="fileSales" accept=".csv" />
      <div class="muted">
        Este CSV es el de ventas/cargas del mes actual (mismo formato que venías usando).
      </div>
    </div>

    <div class="box">
      <div class="section-title">Contactos Whaticket (CSV)</div>
      <input type="file" id="fileContacts" accept=".csv" />
      <div class="muted">
        Debe exportar con columnas: <code>number,name,email,tags,metadata</code>
      </div>
    </div>

    <div class="box" style="max-width:320px">
      <div class="section-title">Opciones</div>
      <div class="hint">
        - Se arma una <b>planilla completa</b> con <b>todos</b> los contactos.<br/>
        - Los que aparecen en cargas ⇒ <span class="pill ok">ACTIVO</span><br/>
        - Los que no aparecen ⇒ <span class="pill bad">NO ACTIVO</span> (para recontactar)
      </div>

      <div style="margin-top:12px">
        <label class="hint" style="display:block;margin-bottom:6px">Límite filas export (0 = sin límite)</label>
        <input type="number" id="maxRows" value="0" min="0" style="width:100%;padding:10px;border-radius:10px;background:#0d131d;border:1px solid #1c2533;color:white">
      </div>

      <div style="margin-top:12px">
        <label class="hint" style="display:flex;gap:8px;align-items:center;cursor:pointer">
          <input type="checkbox" id="onlyNoActive" />
          Exportar SOLO NO ACTIVOS
        </label>
      </div>
    </div>
  </div>

  <button class="btn-main" id="processBtn">Procesar y Comparar</button>

  <div class="btn-row">
    <button class="btn-small" id="exportBtn" disabled>Exportar Planilla (CSV)</button>
    <button class="btn-ghost active" id="viewAll">Vista: Todos</button>
    <button class="btn-ghost" id="viewActive">Vista: Activos</button>
    <button class="btn-ghost" id="viewNoActive">Vista: No Activos</button>
  </div>

  <div id="summary" class="summary">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <span class="pill warn" id="badgeStatus">Sin procesar</span>
      <span class="hint" id="badgeFiles">Cargá los dos archivos y procesá</span>
    </div>

    <div class="kpi-row" style="margin-top:8px">
      <div class="kpi"><div class="k">Contactos totales</div><div class="v" id="kpiTotal">—</div></div>
      <div class="kpi"><div class="k">Detectados ACTIVO</div><div class="v" id="kpiActive">—</div></div>
      <div class="kpi"><div class="k">Detectados NO ACTIVO</div><div class="v" id="kpiNoActive">—</div></div>
    </div>

    <div class="hint" id="matchInfo" style="margin-top:6px">
      Matching por <b>name</b> (contacts) vs <b>usuario/alias</b> (cargas), normalizado (lowercase + trim).
    </div>
  </div>

  <div id="results"></div>
</div>

<div id="toast" class="toast">
  <div class="spinner"></div>
  <div id="toastText">Procesando...</div>
</div>

<script>
/* =========================
   Helpers: Toast
========================= */
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
let toastTimer = null;
function showToast(text, duration=2200) {
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
  toastText.textContent = text;
  toast.classList.add('show');
  toastTimer = setTimeout(()=>{ toast.classList.remove('show'); toastTimer = null; }, duration);
}

/* =========================
   CSV parsing (robust simple)
========================= */
function readCSVFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const text = String(e.target.result || '');
      // normalize line breaks, remove BOM
      const s = text.replace(/\uFEFF/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const lines = s.split('\n').filter(l => l.trim() !== '');
      // remove sep=; lines if any
      const filtered = lines.filter(l => !l.toLowerCase().startsWith('sep='));
      resolve(filtered);
    };
    reader.onerror = reject;
    reader.readAsText(file, 'utf-8');
  });
}

function parseCSVLine(line) {
  const result = [];
  let cur = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (ch === ',' && !inQuotes) { result.push(cur); cur = ''; continue; }
    cur += ch;
  }
  result.push(cur);
  return result.map(v => (v ?? '').trim());
}

function toLowerKey(s) {
  return String(s || '')
    .trim()
    .toLowerCase();
}

function normalizePhone(raw) {
  // keep + and digits; if no +, just digits
  const s = String(raw || '').trim();
  if (!s) return '';
  // Many exports come as +54911... or 54911...
  // We'll keep leading + if present, otherwise leave digits only.
  if (s.startsWith('+')) return '+' + s.slice(1).replace(/\D/g,'');
  return s.replace(/\D/g,'');
}

function csvEscape(v) {
  const s = String(v ?? '');
  if (s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
  return '"' + s + '"';
}

/* =========================
   Parsing: Contacts (Whaticket)
   Header: number,name,email,tags,metadata
========================= */
function parseContacts(lines) {
  if (!lines || lines.length < 2) return { contacts: [], headerOk: false };

  const header = parseCSVLine(lines[0]).map(h => h.toLowerCase());
  const idxNumber = header.indexOf('number');
  const idxName = header.indexOf('name');
  const idxEmail = header.indexOf('email');
  const idxTags = header.indexOf('tags');
  const idxMetadata = header.indexOf('metadata');

  const headerOk = (idxNumber !== -1 && idxName !== -1);

  const contacts = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    const name = (cols[idxName] ?? '').trim();
    const number = normalizePhone(cols[idxNumber] ?? '');
    const email = (idxEmail !== -1 ? (cols[idxEmail] ?? '').trim() : '');
    const tags = (idxTags !== -1 ? (cols[idxTags] ?? '').trim() : '');
    const metadata = (idxMetadata !== -1 ? (cols[idxMetadata] ?? '').trim() : '');

    if (!name && !number) continue;

    contacts.push({
      name,
      nameKey: toLowerKey(name),
      number,
      email,
      tags,
      metadata
    });
  }

  return { contacts, headerOk };
}

/* =========================
   Parsing: Sales / Cargas
   Reutiliza tu idea anterior, pero con detección robusta:
   - si es "mastr": Fecha=0, Monto=3, Usuario=6 (fallback 5)
   - si es "agente": Fecha=0, Monto=2, Usuario=4 (fallback 3)
   AUTO detecta según headers o tamaño de columnas.
========================= */
function detectSalesFormat(lines) {
  // If header includes "Alias jugador" -> mastr
  const first = (lines[0] || '');
  if (/alias\s*jugador/i.test(first) || /alias\s*agente/i.test(first)) return 'mastr';
  // If header includes "Alias" only and has fewer columns -> agente
  if (/alias/i.test(first) && !/alias\s*jugador/i.test(first)) return 'agente';

  // fallback: inspect a data line columns count
  const sampleLine = lines.find((l, idx) => idx > 0 && l.trim() !== '') || '';
  const cols = parseCSVLine(sampleLine);
  if (cols.length >= 7) return 'mastr';
  return 'agente';
}

function parseSales(lines) {
  if (!lines || lines.length < 2) return { rows: [], format: 'unknown' };

  // remove header if looks like header
  const dataLines = (() => {
    const h = lines[0] || '';
    if (/[Ff]echa|[Tt]ipo|Alias|Cantidad|Operaci/i.test(h)) return lines.slice(1);
    return lines.slice(0);
  })();

  const format = detectSalesFormat(lines);
  const rows = [];

  for (const line of dataLines) {
    if (!line || !line.trim()) continue;
    const cols = parseCSVLine(line);
    const fecha = (cols[0] || '').trim();

    let montoRaw = '0';
    let usuario = '';

    if (format === 'mastr') {
      // Fecha (0), Monto (3), Usuario (6) fallback (5)
      montoRaw = (cols[3] !== undefined ? cols[3] : '');
      usuario = (cols[6] || cols[5] || '').trim();
    } else {
      // Fecha (0), Monto (2), Usuario (4) fallback (3)
      montoRaw = (cols[2] !== undefined ? cols[2] : '');
      usuario = (cols[4] || cols[3] || '').trim();
    }

    const monto = parseFloat(String(montoRaw).replace(/\s+/g,'').replace(/[^0-9\.\-]/g,'') || '0') || 0;
    const usuarioKey = toLowerKey(usuario);

    let fechaObj = null;
    if (fecha) {
      fechaObj = new Date(fecha.replace(' ', 'T'));
      if (isNaN(fechaObj.getTime())) fechaObj = new Date(fecha);
    }

    if (!usuarioKey) continue;
    rows.push({ fecha, fechaObj, monto, usuario, usuarioKey });
  }

  return { rows, format };
}

/* =========================
   Aggregation: per user in sales
========================= */
function buildSalesAgg(rows) {
  const agg = new Map();
  for (const r of rows) {
    const key = r.usuarioKey;
    if (!agg.has(key)) {
      agg.set(key, { usuarioKey: key, usuario: r.usuario, operaciones: 0, monto: 0, ultimaFecha: r.fecha, ultimaFechaObj: r.fechaObj });
    }
    const it = agg.get(key);
    it.operaciones += 1;
    it.monto += (r.monto || 0);

    // update last date
    const curTime = (r.fechaObj && !isNaN(r.fechaObj.getTime())) ? r.fechaObj.getTime() : (r.fecha ? Date.parse(r.fecha) : NaN);
    const prevTime = (it.ultimaFechaObj && !isNaN(it.ultimaFechaObj.getTime())) ? it.ultimaFechaObj.getTime() : (it.ultimaFecha ? Date.parse(it.ultimaFecha) : NaN);
    if (!isNaN(curTime) && (isNaN(prevTime) || curTime > prevTime)) {
      it.ultimaFecha = r.fecha;
      it.ultimaFechaObj = r.fechaObj;
      it.usuario = r.usuario;
    }
  }
  return agg;
}

/* =========================
   App State
========================= */
let FINAL_ROWS = []; // full output (all contacts with status)
let VIEW = 'all'; // 'all' | 'active' | 'noactive'

const btnExport = document.getElementById('exportBtn');
const btnProcess = document.getElementById('processBtn');

const viewAll = document.getElementById('viewAll');
const viewActive = document.getElementById('viewActive');
const viewNoActive = document.getElementById('viewNoActive');

function setView(v) {
  VIEW = v;
  [viewAll, viewActive, viewNoActive].forEach(b => b.classList.remove('active'));
  if (v === 'all') viewAll.classList.add('active');
  if (v === 'active') viewActive.classList.add('active');
  if (v === 'noactive') viewNoActive.classList.add('active');
  renderTable();
}

viewAll.addEventListener('click', ()=>setView('all'));
viewActive.addEventListener('click', ()=>setView('active'));
viewNoActive.addEventListener('click', ()=>setView('noactive'));

/* =========================
   Render
========================= */
function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
}

function renderSummary(total, active, noactive, format, contactsHeaderOk) {
  const badgeStatus = document.getElementById('badgeStatus');
  const badgeFiles = document.getElementById('badgeFiles');

  document.getElementById('kpiTotal').textContent = total.toLocaleString();
  document.getElementById('kpiActive').textContent = active.toLocaleString();
  document.getElementById('kpiNoActive').textContent = noactive.toLocaleString();

  badgeStatus.className = 'pill ok';
  badgeStatus.textContent = 'Procesado';
  badgeFiles.textContent = `Formato cargas detectado: ${format}. Contacts header OK: ${contactsHeaderOk ? 'SI' : 'NO'}`;
}

function renderTable() {
  const results = document.getElementById('results');
  if (!FINAL_ROWS || FINAL_ROWS.length === 0) {
    results.innerHTML = `<div class="muted">Sin resultados aún.</div>`;
    btnExport.disabled = true;
    return;
  }

  let rows = FINAL_ROWS.slice();
  if (VIEW === 'active') rows = rows.filter(r => r.estado === 'ACTIVO');
  if (VIEW === 'noactive') rows = rows.filter(r => r.estado === 'NO ACTIVO');

  const maxRows = parseInt(document.getElementById('maxRows').value, 10) || 0;
  if (maxRows > 0) rows = rows.slice(0, maxRows);

  btnExport.disabled = false;

  let html = `
    <div class="muted">
      Mostrando <b>${rows.length}</b> filas (${VIEW === 'all' ? 'todos' : (VIEW === 'active' ? 'activos' : 'no activos')}).
    </div>
    <table>
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Teléfono</th>
          <th>Estado</th>
          <th>Operaciones mes</th>
          <th>Monto mes</th>
          <th>Última fecha</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const r of rows) {
    const pill = r.estado === 'ACTIVO'
      ? `<span class="pill ok">ACTIVO</span>`
      : `<span class="pill bad">NO ACTIVO</span>`;

    html += `
      <tr>
        <td>${escapeHtml(r.usuario)}</td>
        <td>${escapeHtml(r.telefono)}</td>
        <td>${pill}</td>
        <td>${escapeHtml(r.operaciones_mes || '')}</td>
        <td>${escapeHtml(r.monto_mes || '')}</td>
        <td>${escapeHtml(r.ultima_fecha || '')}</td>
        <td>${escapeHtml(r.tags || '')}</td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  results.innerHTML = html;
}

/* =========================
   Export
   Output columns (planilla intermedia):
   usuario,telefono,estado,operaciones_mes,monto_mes,ultima_fecha,origen,tags,metadata,observaciones
========================= */
function exportPlanillaCSV() {
  if (!FINAL_ROWS || FINAL_ROWS.length === 0) return;

  const onlyNoActive = document.getElementById('onlyNoActive').checked;
  let rows = FINAL_ROWS.slice();
  if (onlyNoActive) rows = rows.filter(r => r.estado === 'NO ACTIVO');

  const maxRows = parseInt(document.getElementById('maxRows').value, 10) || 0;
  if (maxRows > 0) rows = rows.slice(0, maxRows);

  let csv = 'usuario,telefono,estado,operaciones_mes,monto_mes,ultima_fecha,origen,tags,metadata,observaciones\n';
  rows.forEach(r => {
    const line = [
      csvEscape(r.usuario),
      csvEscape(r.telefono),
      csvEscape(r.estado),
      csvEscape(r.operaciones_mes),
      csvEscape(r.monto_mes),
      csvEscape(r.ultima_fecha),
      csvEscape(r.origen),
      csvEscape(r.tags),
      csvEscape(r.metadata),
      csvEscape(r.observaciones)
    ].join(',');
    csv += line + '\n';
  });

  downloadFile(csv, `planilla_revinculacion_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
  showToast('Planilla exportada', 1600);
}

function downloadFile(content, fileName, mimeType) {
  const bom = mimeType.includes('csv') ? '\uFEFF' : '';
  const blob = new Blob([bom + content], { type: mimeType });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

btnExport.addEventListener('click', exportPlanillaCSV);

/* =========================
   Main flow: Process
========================= */
btnProcess.addEventListener('click', async () => {
  const fSales = document.getElementById('fileSales').files[0];
  const fContacts = document.getElementById('fileContacts').files[0];
  if (!fSales || !fContacts) return showToast('Cargá ambos CSV primero', 2600);

  showToast('Procesando…', 8000);

  try {
    const [salesLines, contactsLines] = await Promise.all([readCSVFile(fSales), readCSVFile(fContacts)]);

    // Parse contacts
    const { contacts, headerOk } = parseContacts(contactsLines);
    if (!headerOk) {
      showToast('Error: el CSV de contactos no tiene number/name', 3200);
      alert('El CSV de contactos debe tener header: number,name,email,tags,metadata');
      return;
    }

    // Parse sales/cargas and aggregate
    const { rows: salesRows, format } = parseSales(salesLines);
    const agg = buildSalesAgg(salesRows);

    // Build FINAL rows: ALL contacts with status
    const output = [];
    let countActive = 0;
    let countNoActive = 0;

    for (const c of contacts) {
      const key = c.nameKey;

      const salesIt = agg.get(key);
      const isActive = !!salesIt;

      const estado = isActive ? 'ACTIVO' : 'NO ACTIVO';
      if (isActive) countActive++; else countNoActive++;

      output.push({
        usuario: c.name || '',
        telefono: c.number || '',
        estado,
        operaciones_mes: isActive ? String(salesIt.operaciones) : '',
        monto_mes: isActive ? String(Math.round((salesIt.monto || 0) * 100) / 100) : '',
        ultima_fecha: isActive ? (salesIt.ultimaFecha || '') : '',
        origen: 'RECUPERACION_AUTO',
        tags: c.tags || '',
        metadata: c.metadata || '',
        observaciones: ''
      });
    }

    // sort: show NO ACTIVO first (useful for revinculación)
    output.sort((a, b) => {
      if (a.estado !== b.estado) return a.estado === 'NO ACTIVO' ? -1 : 1;
      // secondary: higher monto first
      const ma = parseFloat(a.monto_mes || '0') || 0;
      const mb = parseFloat(b.monto_mes || '0') || 0;
      return mb - ma;
    });

    FINAL_ROWS = output;

    // Summary + render
    renderSummary(contacts.length, countActive, countNoActive, format, headerOk);
    renderTable();
    showToast('Listo — planilla generada', 1600);

  } catch (err) {
    console.error(err);
    showToast('Error procesando archivos', 3200);
    alert('Error procesando archivos: ' + (err && err.message ? err.message : err));
  }
});
</script>

</body>
</html>
