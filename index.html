<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Recuperación • Activos vs No Activos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#131a24;
      --accent:#9aff5c;
      --accent-soft:#c8ff9b;
      --muted:#9aa5b7;
      --border:#1c2533;
      --danger:#ff4d4d;
      --ok:#31ff8a;
      --warn:#ffd35a;
      --row:#0d131d;
      --row2:#0f1722;
    }
    *{box-sizing:border-box;font-family:Inter,Roboto,Arial}
    body{margin:0;padding:26px;min-height:100vh;background:var(--bg);color:white;}
    h1{margin:0 0 14px 0;font-size:22px;font-weight:700;}
    .card{background:var(--card);padding:22px;border-radius:14px;border:1px solid var(--border);box-shadow:0 0 20px #0004;}
    .grid{display:flex;gap:18px;flex-wrap:wrap;}
    .box{flex:1;min-width:300px;background:#0f141d;padding:14px;border-radius:12px;border:1px solid #1b2230;}
    .section-title{font-size:13px;font-weight:800;margin-bottom:10px;color:var(--accent-soft);}
    input[type=file]{width:100%;padding:12px;background:#0d131d;border:1px dashed #2a3647;border-radius:10px;color:var(--muted);cursor:pointer;}
    .btn-main{width:100%;padding:14px;font-size:16px;font-weight:900;background:var(--accent);border:none;border-radius:10px;margin-top:16px;cursor:pointer;color:#121715;}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn-small{padding:10px 14px;font-size:13px;font-weight:900;background:#101a27;color:white;border:1px solid #1c2533;border-radius:10px;cursor:pointer;}
    .btn-small.active{border-color:var(--accent);box-shadow:0 0 0 2px #9aff5c22 inset;}
    .btn-export{background:#c7ffe6;color:#021d16;border:none;}
    .summary{margin-top:14px;padding:12px;border-radius:10px;background:#0d131d;border:1px solid #1c2533;color:var(--muted);font-size:14px;display:grid;gap:8px;}
    .kpis{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:12px;}
    .kpi{background:#0d131d;border:1px solid #1c2533;border-radius:12px;padding:12px;}
    .kpi .label{color:var(--muted);font-size:12px;font-weight:700;}
    .kpi .val{font-size:22px;font-weight:900;margin-top:4px;}
    .val.ok{color:var(--ok);}
    .val.bad{color:var(--danger);}
    .val.neu{color:var(--accent-soft);}
    .options{display:flex;flex-direction:column;gap:10px;}
    label.inline{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center;}
    input[type=number]{width:140px;padding:8px;background:#0d131d;border-radius:8px;border:1px solid #1c2533;color:white;}
    table{width:100%;margin-top:14px;border-collapse:collapse;background:#0d131d;border-radius:12px;overflow:hidden;border:1px solid #1c2533;}
    th,td{padding:10px;border-bottom:1px solid #1c2533;font-size:13px;}
    th{background:#16202c;font-weight:900;color:var(--accent-soft);text-align:left;}
    tr:nth-child(odd) td{background:var(--row);}
    tr:nth-child(even) td{background:var(--row2);}
    tr:hover td{background:#141c27;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid #0000;}
    .pill.ok{background:#0c2a1b;color:var(--ok);border-color:#1a5c3c;}
    .pill.bad{background:#2a1010;color:var(--danger);border-color:#5c1a1a;}
    .muted{color:var(--muted);}
    .toast{position:fixed;right:20px;bottom:20px;background:#16202c;padding:12px 16px;border-radius:10px;opacity:0;transform:translateY(20px);pointer-events:none;transition:.25s;display:flex;gap:10px;align-items:center;border:1px solid #2a3647;}
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto;}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #44546a;border-top-color:var(--accent);animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .note{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}
    .small{font-size:12px;color:var(--muted);}
    @media(max-width: 900px){.kpis{grid-template-columns:1fr;}}
  </style>
</head>
<body>

<h1>Recuperación • Activos vs No Activos</h1>

<div class="card">
  <div class="grid">
    <div class="box">
      <div class="section-title">Cargas del mes (CSV)</div>
      <input type="file" id="fileOps" accept=".csv">
      <div class="note">Este CSV es el de ventas/cargas. Detecto el alias y armo los <b>usuarios únicos activos</b>.</div>
    </div>

    <div class="box">
      <div class="section-title">Contactos Whaticket (CSV)</div>
      <input type="file" id="fileContacts" accept=".csv">
      <div class="note">Debe tener header tipo: <code>number,name,email,tags,metadata</code> (puede tener más columnas, no pasa nada).</div>
    </div>

    <div class="box" style="max-width:320px;">
      <div class="section-title">Opciones</div>
      <div class="options">
        <label class="inline"><input type="checkbox" id="exportOnlyInactive"> Exportar SOLO NO ACTIVOS</label>
        <label class="inline">Límite filas (0 = sin límite)</label>
        <input type="number" id="maxRows" value="0" min="0">
        <label class="inline"><input type="checkbox" id="showDebug"> Mostrar debug de matching</label>
      </div>
      <div class="note">Matching inteligente: busca el alias dentro de <b>name / metadata / email</b> (ej: <code>matiti993//Matias</code> o <code>Matias (matiti993)</code>).</div>
    </div>
  </div>

  <button id="processBtn" class="btn-main">Procesar y Comparar</button>

  <div class="btn-row">
    <button class="btn-small btn-export" id="exportBtn">Exportar Planilla (CSV)</button>
    <button class="btn-small active" data-view="all" id="viewAll">Vista: Todos</button>
    <button class="btn-small" data-view="active" id="viewActive">Vista: Activos</button>
    <button class="btn-small" data-view="inactive" id="viewInactive">Vista: No Activos</button>
  </div>

  <div class="summary" id="summary">
    <div><b id="sumTitle">Sin procesar</b></div>
    <div class="small" id="sumSub">Subí ambos CSV y presioná “Procesar y Comparar”.</div>
    <div class="kpis">
      <div class="kpi">
        <div class="label">Contactos totales</div>
        <div class="val neu" id="kpiTotal">—</div>
      </div>
      <div class="kpi">
        <div class="label">Detectados ACTIVO (match)</div>
        <div class="val ok" id="kpiActive">—</div>
      </div>
      <div class="kpi">
        <div class="label">Detectados NO ACTIVO</div>
        <div class="val bad" id="kpiInactive">—</div>
      </div>
    </div>
    <div class="small" id="kpiExtra"></div>
  </div>

  <div id="results"></div>
</div>

<div id="toast" class="toast">
  <div class="spinner"></div>
  <div id="toastText">Procesando...</div>
</div>

<script>
/* -----------------------------
   Toast
----------------------------- */
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
let toastTimer = null;
function showToast(text, duration=2200) {
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
  toastText.textContent = text;
  toast.classList.add('show');
  toastTimer = setTimeout(()=>{ toast.classList.remove('show'); toastTimer = null; }, duration);
}

/* -----------------------------
   CSV helpers (robusto)
----------------------------- */
function parseCSV(text){
  const rows = [];
  let row = [];
  let field = '';
  let inQuotes = false;
  const s = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  for (let i = 0; i < s.length; i++){
    const ch = s[i];
    const next = s[i+1];

    if (ch === '"'){
      if (inQuotes && next === '"'){ field += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (!inQuotes && ch === ','){
      row.push(field);
      field = '';
      continue;
    }
    if (!inQuotes && ch === '\n'){
      row.push(field);
      field = '';
      if (row.some(v => String(v||'').trim() !== '')) rows.push(row.map(v => String(v||'').trim()));
      row = [];
      continue;
    }
    field += ch;
  }
  row.push(field);
  if (row.some(v => String(v||'').trim() !== '')) rows.push(row.map(v => String(v||'').trim()));
  return rows;
}

function normalizeKey(s){
  return String(s||'').toLowerCase().trim();
}

function csvEscape(v){
  const s = String(v ?? '');
  if (s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
  return '"' + s + '"';
}

function parseDateFlexible(fecha){
  const f = String(fecha||'').trim();
  if (!f) return null;
  // intenta ISO-like
  let d = new Date(f.replace(' ', 'T'));
  if (!isNaN(d.getTime())) return d;
  d = new Date(f);
  if (!isNaN(d.getTime())) return d;
  return null;
}

/* -----------------------------
   Phone normalization (para export + display)
----------------------------- */
function normalizePhone(raw){
  const s = String(raw||'').trim();
  if (!s) return { digits:'', e164:'' };
  let digits = s.replace(/\D/g,'');
  if (!digits) return { digits:'', e164:'' };

  // internacional 00...
  if (s.startsWith('00')){
    const intl = '+' + digits.slice(2);
    return { digits: intl.replace(/\D/g,''), e164: intl };
  }

  let e164 = '';
  if (digits.startsWith('54')) e164 = '+' + digits;
  else{
    if (digits.startsWith('0') && digits.length >= 10) digits = digits.slice(1);
    digits = digits.replace(/^(\d{2,4})15/, '$1');
    e164 = '+54' + digits;
  }
  return { digits: e164.replace(/\D/g,''), e164 };
}

/* -----------------------------
   Matching inteligente: extraer alias del contacto
   - Busca tokens dentro de name/metadata/email
   - Soporta: "alias//Titular", "Titular (alias)", "Titular - alias", etc.
----------------------------- */
function tokensFromText(txt){
  const raw = normalizeKey(txt);
  if (!raw) return [];
  // separa por cualquier no alfanumérico y guión bajo
  return raw.split(/[^a-z0-9_]+/g).filter(Boolean);
}

function extractAliasFromContact(contact, activeAliasSet){
  // 1) intentos rápidos por patrones típicos
  const name = normalizeKey(contact.name);
  if (name){
    // alias//...
    const parts = name.split('//').map(s => s.trim()).filter(Boolean);
    if (parts.length > 1){
      // si el primer tramo coincide con alias, lo usamos
      const a = tokensFromText(parts[0])[0];
      if (a && activeAliasSet.has(a)) return a;
    }
    // (alias)
    const paren = name.match(/\(([^)]+)\)/);
    if (paren){
      const tks = tokensFromText(paren[1]);
      for (const t of tks) if (activeAliasSet.has(t)) return t;
    }
  }

  // 2) tokens de name + metadata + email (orden importa)
  const pool = []
    .concat(tokensFromText(contact.name))
    .concat(tokensFromText(contact.metadata))
    .concat(tokensFromText(contact.email));

  for (const t of pool){
    if (activeAliasSet.has(t)) return t;
  }

  // 3) fallback: primer token del name (para mostrar algo)
  const fallback = tokensFromText(contact.name)[0] || '';
  return fallback;
}

/* -----------------------------
   Parse CARGAS: arma un mapa por alias (usuario)
   Esperado: agent_operations (60).csv o similar
   - Detecto columnas por header si existe; si no, intento por posiciones
----------------------------- */
function detectOpsSchema(rows){
  // devuelve índices aproximados: fecha, monto, usuario
  const headers = (rows[0] || []).map(h => normalizeKey(h));
  const hasHeader = headers.some(h => ['fecha','date'].includes(h) || h.includes('fecha'));
  if (!hasHeader) return { header:false, fecha:0, monto:2, usuario:4 };

  const findIdx = (cands) => headers.findIndex(h => cands.some(c => h === c || h.includes(c)));

  const idxFecha = findIdx(['fecha','date','datetime']);
  const idxMonto = findIdx(['cantidad','monto','importe','amount','total']);
  // alias/usuario: en tus ejemplos puede ser alias jugador / alias
  let idxUser = findIdx(['alias jugador','alias','usuario','user','nick','nickname']);
  if (idxUser === -1) idxUser = 4;

  return {
    header:true,
    fecha: idxFecha !== -1 ? idxFecha : 0,
    monto: idxMonto !== -1 ? idxMonto : 2,
    usuario: idxUser
  };
}

function parseOps(rows){
  if (!rows || rows.length < 2) return { activeAliasSet:new Set(), statsByAlias:new Map(), uniques:0, totalRows:0 };

  const schema = detectOpsSchema(rows);
  const start = schema.header ? 1 : 0;
  const statsByAlias = new Map();

  for (let i = start; i < rows.length; i++){
    const r = rows[i];
    if (!r || r.length === 0) continue;

    const fechaStr = (r[schema.fecha] ?? '').trim();
    const usuarioRaw = (r[schema.usuario] ?? '').trim();
    if (!usuarioRaw) continue;

    // Limpieza alias (lower + trim)
    const usuario = normalizeKey(usuarioRaw);
    if (!usuario) continue;

    // monto
    let mRaw = (r[schema.monto] ?? '').toString();
    mRaw = mRaw.replace(/\s+/g,'').replace(/[^0-9\.\-]/g,'');
    const monto = parseFloat(mRaw) || 0;

    const d = parseDateFlexible(fechaStr);
    const prev = statsByAlias.get(usuario) || { usuario, ops:0, monto:0, lastDate:null, lastFecha:'' };
    prev.ops += 1;
    prev.monto += monto;

    if (d && (!prev.lastDate || d.getTime() > prev.lastDate.getTime())){
      prev.lastDate = d;
      prev.lastFecha = fechaStr;
    } else if (!prev.lastFecha && fechaStr){
      prev.lastFecha = fechaStr;
    }

    statsByAlias.set(usuario, prev);
  }

  const activeAliasSet = new Set(statsByAlias.keys());
  return { activeAliasSet, statsByAlias, uniques: activeAliasSet.size, totalRows: (schema.header ? rows.length-1 : rows.length) };
}

/* -----------------------------
   Parse CONTACTOS Whaticket:
   header esperado: number,name,email,tags,metadata (puede venir con extras)
----------------------------- */
function findHeaderIndex(headers, candidates){
  const hl = headers.map(h => normalizeKey(h));
  for (let i = 0; i < hl.length; i++){
    const h = hl[i];
    if (candidates.some(c => h === c || h.includes(c))) return i;
  }
  return -1;
}

function parseContacts(rows){
  if (!rows || rows.length < 2) return [];
  const headers = rows[0] || [];
  const idxNumber = findHeaderIndex(headers, ['number','telefono','tel','phone','celular','mobile']);
  const idxName = findHeaderIndex(headers, ['name','nombre']);
  const idxEmail = findHeaderIndex(headers, ['email','mail']);
  const idxTags = findHeaderIndex(headers, ['tags','tag']);
  const idxMeta = findHeaderIndex(headers, ['metadata','meta']);

  const contacts = [];
  for (let i = 1; i < rows.length; i++){
    const r = rows[i];
    if (!r || r.length === 0) continue;

    const number = (idxNumber !== -1 ? (r[idxNumber] ?? '') : '').trim();
    const name = (idxName !== -1 ? (r[idxName] ?? '') : '').trim();
    const email = (idxEmail !== -1 ? (r[idxEmail] ?? '') : '').trim();
    const tags = (idxTags !== -1 ? (r[idxTags] ?? '') : '').trim();
    const metadata = (idxMeta !== -1 ? (r[idxMeta] ?? '') : '').trim();

    // descartar filas totalmente vacías
    if (!number && !name && !email && !tags && !metadata) continue;

    const phone = normalizePhone(number);
    contacts.push({
      numberRaw: number,
      numberE164: phone.e164 || '',
      numberDigits: phone.digits || '',
      name,
      email,
      tags,
      metadata
    });
  }
  return contacts;
}

/* -----------------------------
   App State + Render
----------------------------- */
let state = {
  ops: null,             // { activeAliasSet, statsByAlias, uniques, totalRows }
  contacts: [],
  rowsAll: [],
  view: 'all',           // all | active | inactive
  lastExportRows: []
};

function setView(v){
  state.view = v;
  document.getElementById('viewAll').classList.toggle('active', v === 'all');
  document.getElementById('viewActive').classList.toggle('active', v === 'active');
  document.getElementById('viewInactive').classList.toggle('active', v === 'inactive');
  renderTable();
}

document.getElementById('viewAll').addEventListener('click', ()=>setView('all'));
document.getElementById('viewActive').addEventListener('click', ()=>setView('active'));
document.getElementById('viewInactive').addEventListener('click', ()=>setView('inactive'));

function renderKPIs(){
  const total = state.rowsAll.length;
  const active = state.rowsAll.filter(r => r.estado === 'ACTIVO').length;
  const inactive = total - active;

  document.getElementById('kpiTotal').textContent = total.toLocaleString('es-AR');
  document.getElementById('kpiActive').textContent = active.toLocaleString('es-AR');
  document.getElementById('kpiInactive').textContent = inactive.toLocaleString('es-AR');

  const opsUniques = state.ops ? state.ops.uniques : 0;
  const opsRows = state.ops ? state.ops.totalRows : 0;

  document.getElementById('sumTitle').textContent = 'Procesado';
  document.getElementById('sumSub').textContent =
    `Ops: ${opsRows.toLocaleString('es-AR')} registros • ${opsUniques.toLocaleString('es-AR')} usuarios únicos activos (alias únicos). ` +
    `Contacts: ${state.contacts.length.toLocaleString('es-AR')} filas.`;

  document.getElementById('kpiExtra').textContent =
    `Matching: busco alias dentro de name/metadata/email (soporta alias primero o titular primero).`;
}

function escapeHtml(s){
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function renderTable(){
  const maxRows = parseInt(document.getElementById('maxRows').value, 10) || 0;
  const showDebug = document.getElementById('showDebug').checked;

  let rows = state.rowsAll.slice();
  if (state.view === 'active') rows = rows.filter(r => r.estado === 'ACTIVO');
  if (state.view === 'inactive') rows = rows.filter(r => r.estado === 'NO ACTIVO');

  // export respects "export only inactive"
  state.lastExportRows = rows;

  if (maxRows > 0) rows = rows.slice(0, maxRows);

  if (!rows.length){
    document.getElementById('results').innerHTML = `<div class="muted" style="margin-top:14px;">Sin filas para mostrar.</div>`;
    return;
  }

  let html = '';
  html += `<table><thead><tr>
    <th>Usuario (alias detectado)</th>
    <th>Teléfono</th>
    <th>Estado</th>
    <th>Operaciones mes</th>
    <th>Monto mes</th>
    <th>Última fecha</th>
    <th>Tags</th>
    ${showDebug ? `<th class="muted">Debug match</th>` : ``}
  </tr></thead><tbody>`;

  for (const r of rows){
    const pill = r.estado === 'ACTIVO'
      ? `<span class="pill ok">ACTIVO</span>`
      : `<span class="pill bad">NO ACTIVO</span>`;

    html += `<tr>
      <td>${escapeHtml(r.usuario || '')}</td>
      <td>${escapeHtml(r.telefono || '')}</td>
      <td>${pill}</td>
      <td>${(r.ops || 0).toLocaleString('es-AR')}</td>
      <td>$${(r.monto || 0).toLocaleString('es-AR')}</td>
      <td>${escapeHtml(r.ultimaFecha || '')}</td>
      <td>${escapeHtml(r.tags || '')}</td>
      ${showDebug ? `<td class="muted">${escapeHtml(r.debug || '')}</td>` : ``}
    </tr>`;
  }

  html += `</tbody></table>`;
  document.getElementById('results').innerHTML = html;
}

/* -----------------------------
   Export CSV (planilla simple para tu “otro proceso”)
   Te dejo columnas "whaticket-like" + estado activo
----------------------------- */
function exportCSV(){
  if (!state.rowsAll.length) return showToast('No hay datos para exportar', 1800);

  const onlyInactive = document.getElementById('exportOnlyInactive').checked;
  let rows = state.rowsAll.slice();
  if (onlyInactive) rows = rows.filter(r => r.estado === 'NO ACTIVO');

  const maxRows = parseInt(document.getElementById('maxRows').value, 10) || 0;
  if (maxRows > 0) rows = rows.slice(0, maxRows);

  // Cabecera final (simple y limpia)
  // Si querés EXACTO al formato de tu planilla vieja, decímelo y lo adapto a ese header.
  const header = [
    'usuario',
    'telefono',
    'estado',
    'operaciones_mes',
    'monto_mes',
    'ultima_fecha',
    'tags',
    'email',
    'metadata'
  ].join(',');

  let csv = header + '\n';
  for (const r of rows){
    csv += [
      csvEscape(r.usuario || ''),
      csvEscape(r.telefono || ''),
      csvEscape(r.estado || ''),
      csvEscape(r.ops || 0),
      csvEscape(r.monto || 0),
      csvEscape(r.ultimaFecha || ''),
      csvEscape(r.tags || ''),
      csvEscape(r.email || ''),
      csvEscape(r.metadata || '')
    ].join(',') + '\n';
  }

  const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `recuperacion_${onlyInactive ? 'NO_ACTIVOS' : 'COMPLETO'}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast('CSV exportado', 1500);
}

document.getElementById('exportBtn').addEventListener('click', exportCSV);

/* -----------------------------
   Main: procesar y comparar
----------------------------- */
async function readFileText(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(String(e.target.result || ''));
    r.onerror = reject;
    r.readAsText(file, 'utf-8');
  });
}

document.getElementById('processBtn').addEventListener('click', async () => {
  const opsFile = document.getElementById('fileOps').files[0];
  const contactsFile = document.getElementById('fileContacts').files[0];
  if (!opsFile || !contactsFile) return showToast('Cargá ambos CSV primero', 2400);

  showToast('Procesando…', 9000);

  try{
    const [opsText, contactsText] = await Promise.all([readFileText(opsFile), readFileText(contactsFile)]);
    const opsRows = parseCSV(opsText);
    const contactsRows = parseCSV(contactsText);

    const ops = parseOps(opsRows);             // {activeAliasSet, statsByAlias, uniques, totalRows}
    const contacts = parseContacts(contactsRows);

    state.ops = ops;
    state.contacts = contacts;

    // Construir planilla completa: TODOS los contactos marcados ACTIVO/NO ACTIVO
    const out = [];
    let matched = 0;

    for (const c of contacts){
      const alias = extractAliasFromContact(c, ops.activeAliasSet);
      const isActive = alias && ops.activeAliasSet.has(alias);

      const stats = isActive ? ops.statsByAlias.get(alias) : null;
      if (isActive) matched++;

      out.push({
        usuario: alias || (normalizeKey(c.name) || ''),  // lo que usaremos como “usuario”
        telefono: c.numberE164 || c.numberRaw || '',
        estado: isActive ? 'ACTIVO' : 'NO ACTIVO',
        ops: stats ? stats.ops : 0,
