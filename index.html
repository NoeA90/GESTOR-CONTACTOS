<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NEXO SMOKY • Activos vs No Activos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f17;
      --card:#131a24;
      --accent:#9aff5c;
      --accent2:#5cf6ff;
      --danger:#ff5c5c;
      --muted:#9aa5b7;
      --border:#1c2533;
      --chip:#0d131d;
    }
    *{box-sizing:border-box;font-family:Inter,Roboto,Arial}
    body{margin:0;padding:22px;min-height:100vh;background:var(--bg);color:#fff}
    h1{margin:0 0 8px 0;font-size:22px;font-weight:900}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px;line-height:1.35}
    .card{background:var(--card);padding:18px;border-radius:14px;border:1px solid var(--border);
      box-shadow:0 0 20px #0004;margin-bottom:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .box{flex:1;background:#0f141d;padding:14px;border-radius:12px;border:1px solid #1b2230;min-width:280px}
    .section-title{font-size:13px;font-weight:900;margin:0 0 10px 0;color:#c8ff9b}
    input[type=file]{width:100%;padding:12px;background:#0d131d;border:1px dashed #2a3647;border-radius:10px;color:var(--muted);cursor:pointer}
    .hint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
    .btn-main{width:100%;padding:14px;font-size:15px;font-weight:1000;background:var(--accent);
      border:none;border-radius:10px;cursor:pointer;color:#121715;margin-top:14px}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #273347;background:#0d131d;color:#fff;cursor:pointer;font-weight:900;font-size:13px}
    .btn:hover{filter:brightness(1.08)}
    .btn-green{border-color:#2c6b2c}
    .btn-red{border-color:#6b2c2c}
    .btn-cyan{border-color:#2c6b6b}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .pill{padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid #1c2533;color:var(--muted);font-size:12px;font-weight:900}
    .stats{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:12px;margin-top:14px}
    .stat{background:#0d131d;border:1px solid #1c2533;border-radius:14px;padding:12px}
    .stat .label{font-size:12px;color:var(--muted);font-weight:900}
    .stat .value{font-size:28px;font-weight:1000;margin-top:6px}
    .green{color:var(--accent)} .red{color:var(--danger)} .cyan{color:var(--accent2)}
    .summary{margin-top:12px;padding:12px;border-radius:12px;background:#0d131d;border:1px solid #1c2533;color:var(--muted);
      font-size:13px;line-height:1.45}
    table{width:100%;margin-top:14px;border-collapse:collapse;background:#0d131d;border-radius:12px;overflow:hidden;border:1px solid #1c2533}
    th,td{padding:10px;border-bottom:1px solid #1c2533;font-size:13px;vertical-align:top}
    th{background:#16202c;font-weight:1000;color:#c8ff9b;position:sticky;top:0;z-index:1}
    tr:hover td{background:#141c27}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:1000;font-size:12px;border:1px solid;white-space:nowrap}
    .b-active{color:var(--accent);border-color:#2c6b2c;background:#0c1b12}
    .b-inactive{color:var(--danger);border-color:#6b2c2c;background:#1b0c0c}
    .toast{position:fixed;right:18px;bottom:18px;background:#16202c;padding:12px 14px;border-radius:12px;opacity:0;
      transform:translateY(16px);pointer-events:none;transition:.25s;display:flex;gap:10px;align-items:center;border:1px solid #2a3647;max-width:420px}
    .toast.show{opacity:1;transform:translateY(0);pointer-events:auto}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #44546a;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .optline{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input[type=number]{width:160px;padding:8px;background:#0d131d;border-radius:10px;border:1px solid #1c2533;color:#fff;font-weight:900}
    label.inline{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;font-weight:900}
    .smallnote{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .logoBox{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .logoPh{width:38px;height:38px;border-radius:10px;background:linear-gradient(180deg,#243044,#101827);border:1px solid #2a3647}
    @media (max-width:900px){ .stats{grid-template-columns:repeat(2,minmax(180px,1fr));} }
  </style>
</head>
<body>

<div class="logoBox">
  <div class="logoPh" title="Logo NEXO (placeholder)"></div>
  <div>
    <h1>NEXO SMOKY</h1>
    <div class="sub">
      Fusiona: <b>Contactos Whaticket</b> + <b>Cargas/Operaciones</b> → marca <b>JUGANDO</b> vs <b>A CONTACTAR</b> y exporta planilla lista.
    </div>
  </div>
</div>

<div class="card">
  <div class="row">
    <div class="box">
      <div class="section-title">Cargas del mes / Operaciones (CSV)</div>
      <input type="file" id="fileOps" accept=".csv" />
      <div class="hint">
        CSV de operaciones. Detecta separador <b>,</b> o <b>;</b>. Busca columnas tipo: fecha, cantidad/monto, alias/usuario/jugador/titular.
      </div>
    </div>

    <div class="box">
      <div class="section-title">Contactos Whaticket (CSV)</div>
      <input type="file" id="fileContacts" accept=".csv" />
      <div class="hint">
        Debe exportar: <b>number,name,email,tags,metadata</b><br/>
        Ej name: <b>0011mar//Nombre Apellido</b> (alias = 0011mar)
      </div>
    </div>

    <div class="box" style="max-width:460px">
      <div class="section-title">Opciones</div>

      <div class="optline">
        <label class="inline"><input type="checkbox" id="exportOnlyNoActivos"> Exportar SOLO A CONTACTAR</label>
        <label class="inline"><input type="checkbox" id="showDebug"> Mostrar debug (console)</label>
      </div>

      <div class="optline">
        <div class="pill">Límite filas export (0 = sin límite)</div>
        <input type="number" id="limitRows" value="0" min="0" />
      </div>

      <div class="smallnote">
        ✅ ACTIVO se exporta como: <span class="badge b-active">JUGANDO</span><br/>
        ❌ NO ACTIVO se exporta como: <span class="badge b-inactive">A CONTACTAR</span><br/>
        <span style="opacity:.9">El sistema usa Web Worker para que Chrome no se cuelgue con 33k.</span>
      </div>
    </div>
  </div>

  <button id="processBtn" class="btn-main">Procesar y Comparar (sin colgar Chrome)</button>

  <div class="toolbar">
    <button class="btn btn-cyan" id="exportPlanillaBtn">Exportar Planilla Blanca (CSV)</button>
    <button class="btn btn-cyan" id="exportWhaticketBtn">Exportar CSV Whaticket (tags)</button>
    <button class="btn" id="viewAllBtn">Vista: Todos</button>
    <button class="btn btn-green" id="viewActivosBtn">Vista: Jugando</button>
    <button class="btn btn-red" id="viewNoActivosBtn">Vista: A contactar</button>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="label">Contactos totales (WTK)</div>
      <div class="value green" id="statContacts">0</div>
    </div>
    <div class="stat">
      <div class="label">Usuarios únicos activos (ops)</div>
      <div class="value cyan" id="statOpsActivos">0</div>
    </div>
    <div class="stat">
      <div class="label">Match ACTIVO (en WTK)</div>
      <div class="value green" id="statMatchActivos">0</div>
    </div>
    <div class="stat">
      <div class="label">A contactar (en WTK)</div>
      <div class="value red" id="statNoActivos">0</div>
    </div>
  </div>

  <div id="summary" class="summary">Sin procesar.</div>
  <div id="results"></div>
</div>

<div id="toast" class="toast">
  <div class="spinner"></div>
  <div id="toastText">Procesando...</div>
</div>

<script>
/* =========================
   Toast + utils
========================= */
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
let toastTimer = null;
function showToast(text, duration=2200) {
  if (toastTimer) { clearTimeout(toastTimer); toastTimer = null; }
  toastText.textContent = text;
  toast.classList.add('show');
  toastTimer = setTimeout(()=>{ toast.classList.remove('show'); toastTimer = null; }, duration);
}
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
}
function readFileText(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(String(e.target.result || ''));
    r.onerror = reject;
    r.readAsText(file, 'utf-8');
  });
}

/* =========================
   Worker (para no colgar Chrome)
========================= */
const workerCode = `
  let STATE = {
    merged: [],
    activeSetSize: 0,
    contactsCount: 0,
    matchActivos: 0,
    noActivos: 0,
    opsRows: 0,
    debug: {}
  };

  function detectDelimiter(text) {
    const lines = String(text||'').replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n').split('\\n').filter(l => l.trim() !== '');
    if (/^sep=;/i.test(lines[0] || '')) return ';';
    if (/^sep=,/i.test(lines[0] || '')) return ',';
    const head = lines.slice(0, 5).join('\\n');
    const commas = (head.match(/,/g) || []).length;
    const semis  = (head.match(/;/g) || []).length;
    return semis > commas ? ';' : ',';
  }

  function parseCSVLine(line, delim) {
    const result = [];
    let cur = '';
    let inQuotes = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (ch === delim && !inQuotes) { result.push(cur); cur=''; continue; }
      cur += ch;
    }
    result.push(cur);
    return result;
  }

  function parseCSV(text) {
    const clean = String(text || '').replace(/\\uFEFF/g,'');
    const delim = detectDelimiter(clean);
    const lines = clean.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n').split('\\n').filter(l => l.trim() !== '');
    const filtered = lines.filter(l => !/^sep=/i.test(l.trim()));
    if (filtered.length === 0) return { delim, headers: [], rows: [] };
    const headers = parseCSVLine(filtered[0], delim).map(h => String(h||'').trim());
    const rows = filtered.slice(1).map(l => parseCSVLine(l, delim));
    return { delim, headers, rows };
  }

  function findHeaderIndex(headersLower, candidates) {
    for (let i=0;i<headersLower.length;i++){
      const h = headersLower[i];
      if (candidates.some(c => h === c || h.includes(c))) return i;
    }
    return -1;
  }

  function cleanAliasBase(s) {
    if (!s) return '';
    return String(s)
      .toLowerCase()
      .trim()
      .replace(/\\uFEFF/g,'')
      .replace(/\\s+/g,' ')
      .replace(/["']/g,'')
      .replace(/^[^a-z0-9]+|[^a-z0-9]+$/g,'');
  }

  function getAliasFromContactName(name) {
    const raw = cleanAliasBase(name);
    if (!raw) return '';
    if (raw.includes('//')) return cleanAliasBase(raw.split('//')[0]);
    return raw;
  }

  function parseNumberLoose(v) {
    let s = String(v ?? '').trim();
    if (!s) return 0;
    s = s.replace(/\\s+/g,'');
    s = s.replace(/[^0-9\\-,.]/g,'');
    if (s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
    if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function parseOpsCSV(text) {
    const { delim, headers, rows } = parseCSV(text);
    const headersLower = headers.map(h => String(h||'').toLowerCase().trim());

    const idxFecha = findHeaderIndex(headersLower, ['fecha','date','datetime']);
    const idxMonto = findHeaderIndex(headersLower, ['cantidad','monto','importe','amount','balance']);
    const idxAlias = findHeaderIndex(headersLower, ['alias','usuario','user','player','jugador','titular','cliente']);

    const F_idxFecha = idxFecha !== -1 ? idxFecha : 0;
    const F_idxMonto = idxMonto !== -1 ? idxMonto : (delim === ';' ? 2 : 3);
    const F_idxUser  = idxAlias !== -1 ? idxAlias : 4;

    const agg = new Map();
    let rowsCount = 0;

    for (const r of rows) {
      if (!r || r.length === 0) continue;
      const userRaw = r[F_idxUser] ?? '';
      const usuario = cleanAliasBase(userRaw);
      if (!usuario) continue;

      const monto = parseNumberLoose(r[F_idxMonto] ?? '');
      rowsCount++;

      if (!agg.has(usuario)) agg.set(usuario, { count:0, totalMonto:0 });
      const it = agg.get(usuario);
      it.count += 1;
      it.totalMonto += (monto || 0);
    }

    return { delim, headers, rowsCount, agg };
  }

  function parseContactsCSV(text) {
    const { delim, headers, rows } = parseCSV(text);
    const headersLower = headers.map(h => String(h||'').toLowerCase().trim());

    const idxNumber = findHeaderIndex(headersLower, ['number','telefono','tel','phone']);
    const idxName   = findHeaderIndex(headersLower, ['name','nombre']);
    const idxEmail  = findHeaderIndex(headersLower, ['email']);
    const idxTags   = findHeaderIndex(headersLower, ['tags']);
    const idxMeta   = findHeaderIndex(headersLower, ['metadata']);

    const contacts = [];
    for (const r of rows) {
      if (!r || r.length === 0) continue;
      const number = String(r[idxNumber] ?? '').trim();
      const name   = String(r[idxName] ?? '').trim();
      if (!number && !name) continue;

      const alias = getAliasFromContactName(name);
      contacts.push({
        number,
        name,
        email: String(r[idxEmail] ?? '').trim(),
        tags: String(r[idxTags] ?? '').trim(),
        metadata: String(r[idxMeta] ?? '').trim(),
        alias
      });
    }

    return { delim, headers, contacts, okHeader: (idxNumber !== -1 && idxName !== -1) };
  }

  function buildMerged(contacts, opsAgg) {
    const activeSet = new Set(opsAgg.keys());
    let matchActivos = 0;
    let noActivos = 0;

    const merged = contacts.map(c => {
      const alias = c.alias;
      const isActive = alias && activeSet.has(alias);
      if (isActive) matchActivos++; else noActivos++;

      return {
        ...c,
        status: isActive ? 'JUGANDO' : 'A CONTACTAR',
        opsCount: isActive ? opsAgg.get(alias).count : 0,
        opsMonto: isActive ? opsAgg.get(alias).totalMonto : 0
      };
    });

    return { merged, activeSetSize: activeSet.size, matchActivos, noActivos };
  }

  function csvEscape(v) {
    const s = String(v ?? '');
    return '"' + s.replace(/"/g,'""') + '"';
  }

  function exportPlanillaBlanca(merged, onlyNoAct, maxRows) {
    let rows = merged.slice();
    if (onlyNoAct) rows = rows.filter(r => r.status === 'A CONTACTAR');
    if (maxRows > 0) rows = rows.slice(0, maxRows);

    // ✅ Mantengo tu header y le agrego al final "telefono" para que NO ROMPA lo anterior,
    // pero te deja el número listo para el siguiente gestor.
    const headers =
'usuarios,estado de revision,,estado actual,"VISTO, RESPONDIDO?",RECUPERADO,TURNO DE LAS CARGAS,interesado en jugar?,ya contactados,recuperados!,actualmente cargando,TURNO MAÑANA,TURNO TARDE,TURNO NOCHE,contactos a borrar,telefono\\n';

    // En tu lógica: Activo => JUGANDO; No activo => A CONTACTAR
    const estadoRevision = (r) => r.status === 'JUGANDO' ? 'JUGANDO' : 'A CONTACTAR';

    let csv = headers;

    // Columna "actualmente cargando": dejamos SOLO usuarios JUGANDO (para que el otro gestor los detecte)
    const actualmenteJugando = rows.filter(r => r.status === 'JUGANDO').map(r => (r.alias || r.name || ''));

    const maxLength = Math.max(rows.length, actualmenteJugando.length);

    for (let i=0;i<maxLength;i++){
      const r = rows[i];
      const usuario = r ? (r.alias || r.name || '') : '';
      const est = r ? estadoRevision(r) : '';
      const phone = r ? (r.number ? (r.number.startsWith('+') ? r.number : ('+'+r.number)) : '') : '';

      const line = [
        r ? csvEscape(usuario) : '',
        r ? csvEscape(est) : '',
        '',
        r ? csvEscape(est) : '',
        csvEscape('NO'),
        csvEscape('NO'),
        '',
        csvEscape('NO'),
        csvEscape(''),
        csvEscape(''),
        csvEscape(actualmenteJugando[i] || ''),
        csvEscape(''),
        csvEscape(''),
        csvEscape(''),
        csvEscape(''),
        csvEscape(phone)
      ].join(',');

      csv += line + '\\n';
    }

    return csv;
  }

  function exportWhaticketCSV(merged, tagActivo='ACTIVO', tagNoActivo='A_CONTACTAR', maxRows=0) {
    let rows = merged.slice();
    if (maxRows > 0) rows = rows.slice(0, maxRows);

    const headers = 'number,name,email,tags,metadata\\n';
    let csv = headers;

    for (const r of rows) {
      const num = r.number || '';
      const name = r.name || '';
      const email = r.email || '';
      let tags = (r.tags || '').trim();
      const add = (r.status === 'JUGANDO') ? tagActivo : tagNoActivo;

      // evita duplicar tag
      const tagsArr = tags ? tags.split(',').map(t=>t.trim()).filter(Boolean) : [];
      const has = tagsArr.some(t => t.toLowerCase() === add.toLowerCase());
      if (!has) tagsArr.push(add);
      tags = tagsArr.join(',');

      csv += [
        csvEscape(num),
        csvEscape(name),
        csvEscape(email),
        csvEscape(tags),
        csvEscape(r.metadata || '')
      ].join(',') + '\\n';
    }

    return csv;
  }

  self.onmessage = (ev) => {
    const { type, opsText, contactsText, onlyNoAct, limitRows, exportMaxRows } = ev.data || {};

    if (type === 'PROCESS') {
      const ops = parseOpsCSV(opsText);
      const contacts = parseContactsCSV(contactsText);

      const mergedPack = buildMerged(contacts.contacts, ops.agg);

      STATE.merged = mergedPack.merged;
      STATE.activeSetSize = mergedPack.activeSetSize;
      STATE.contactsCount = contacts.contacts.length;
      STATE.matchActivos = mergedPack.matchActivos;
      STATE.noActivos = mergedPack.noActivos;
      STATE.opsRows = ops.rowsCount;
      STATE.debug = {
        ops_delim: ops.delim,
        contacts_delim: contacts.delim,
        contacts_header_ok: contacts.okHeader,
        ops_headers: ops.headers
      };

      // preview chico (para render sin colgar)
      const previewLimit = 1200;
      const preview = STATE.merged.slice(0, previewLimit);

      self.postMessage({
        type:'PROCESS_DONE',
        stats: {
          contacts: STATE.contactsCount,
          opsActivos: STATE.activeSetSize,
          matchActivos: STATE.matchActivos,
          noActivos: STATE.noActivos,
          opsRows: STATE.opsRows
        },
        debug: STATE.debug,
        preview,
        previewLimit
      });
      return;
    }

    if (type === 'EXPORT_PLANILLA') {
      const csv = exportPlanillaBlanca(STATE.merged, !!onlyNoAct, exportMaxRows || 0);
      self.postMessage({ type:'EXPORT_PLANILLA_DONE', csv });
      return;
    }

    if (type === 'EXPORT_WTK') {
      const csv = exportWhaticketCSV(STATE.merged, 'ACTIVO', 'A_CONTACTAR', exportMaxRows || 0);
      self.postMessage({ type:'EXPORT_WTK_DONE', csv });
      return;
    }
  };
`;

const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type:'text/javascript'})));

let App = {
  view: 'all',
  stats: {contacts:0, opsActivos:0, matchActivos:0, noActivos:0, opsRows:0},
  debug: {},
  preview: [],
  previewLimit: 1200
};

function downloadFile(content, fileName, mimeType) {
  const bom = mimeType.includes('csv') ? '\uFEFF' : '';
  const blob = new Blob([bom + content], { type: mimeType });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function render() {
  const statContacts = document.getElementById('statContacts');
  const statOpsActivos = document.getElementById('statOpsActivos');
  const statMatchActivos = document.getElementById('statMatchActivos');
  const statNoActivos = document.getElementById('statNoActivos');
  const summary = document.getElementById('summary');
  const results = document.getElementById('results');

  statContacts.textContent = (App.stats.contacts||0).toLocaleString('es-AR');
  statOpsActivos.textContent = (App.stats.opsActivos||0).toLocaleString('es-AR');
  statMatchActivos.textContent = (App.stats.matchActivos||0).toLocaleString('es-AR');
  statNoActivos.textContent = (App.stats.noActivos||0).toLocaleString('es-AR');

  const dbg = document.getElementById('showDebug').checked;
  const dbgLine = dbg
    ? `<div style="margin-top:8px"><b>Debug:</b> ops_delim="${escapeHtml(App.debug.ops_delim)}" • contacts_delim="${escapeHtml(App.debug.contacts_delim)}" • contacts_header_ok=${App.debug.contacts_header_ok ? 'true' : 'false'}</div>`
    : '';

  summary.innerHTML = `
    <b>Procesado</b><br/>
    Ops: <b>${(App.stats.opsRows||0).toLocaleString('es-AR')}</b> registros •
    <b>${(App.stats.opsActivos||0).toLocaleString('es-AR')}</b> usuarios únicos activos.<br/>
    Contacts: <b>${(App.stats.contacts||0).toLocaleString('es-AR')}</b> filas.<br/>
    Vista: <b>${App.view === 'all' ? 'Todos' : (App.view === 'active' ? 'JUGANDO' : 'A CONTACTAR')}</b>.
    ${dbgLine}
  `;

  // Filtra preview según vista (sin colgar)
  let showing = App.preview.slice();
  if (App.view === 'active') showing = showing.filter(r => r.status === 'JUGANDO');
  if (App.view === 'inactive') showing = showing.filter(r => r.status === 'A CONTACTAR');

  let html = '';
  html += `<div class="pill">Mostrando preview: ${showing.length.toLocaleString('es-AR')} filas (máx ${App.previewLimit}). Exporta completo sin preview.</div>`;

  html += `
    <table>
      <thead>
        <tr>
          <th>Alias</th>
          <th>Teléfono</th>
          <th>Estado</th>
          <th>Ops mes</th>
          <th>Monto mes</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const r of showing) {
    const badge = r.status === 'JUGANDO'
      ? `<span class="badge b-active">JUGANDO</span>`
      : `<span class="badge b-inactive">A CONTACTAR</span>`;

    const phone = r.number ? (r.number.startsWith('+') ? r.number : ('+'+r.number)) : '';
    const alias = r.alias || '';

    html += `
      <tr>
        <td>${escapeHtml(alias)}</td>
        <td>${escapeHtml(phone)}</td>
        <td>${badge}</td>
        <td>${(r.opsCount||0).toLocaleString('es-AR')}</td>
        <td>$${(r.opsMonto||0).toLocaleString('es-AR')}</td>
        <td>${escapeHtml(r.tags || '')}</td>
      </tr>
    `;
  }

  html += `</tbody></table>`;
  results.innerHTML = html;
}

worker.onmessage = (ev) => {
  const msg = ev.data || {};
  if (msg.type === 'PROCESS_DONE') {
    App.stats = msg.stats || App.stats;
    App.debug = msg.debug || {};
    App.preview = msg.preview || [];
    App.previewLimit = msg.previewLimit || 1200;

    if (document.getElementById('showDebug').checked) {
      console.log('DEBUG', {stats: App.stats, debug: App.debug});
    }

    render();
    showToast('Listo — comparación lista', 1600);
  }

  if (msg.type === 'EXPORT_PLANILLA_DONE') {
    const name = `planilla_exportada_${new Date().toISOString().slice(0,10)}.csv`;
    downloadFile(msg.csv || '', name, 'text/csv;charset=utf-8;');
    showToast('Planilla Blanca exportada');
  }

  if (msg.type === 'EXPORT_WTK_DONE') {
    const name = `whaticket_tags_${new Date().toISOString().slice(0,10)}.csv`;
    downloadFile(msg.csv || '', name, 'text/csv;charset=utf-8;');
    showToast('CSV Whaticket exportado');
  }
};

/* =========================
   Handlers UI
========================= */
document.getElementById('processBtn').addEventListener('click', async () => {
  const fOps = document.getElementById('fileOps').files[0];
  const fContacts = document.getElementById('fileContacts').files[0];
  if (!fOps || !fContacts) return showToast('Cargá ambos CSV', 2500);

  showToast('Procesando en background (Worker)…', 8000);

  try {
    const [opsText, contactsText] = await Promise.all([ readFileText(fOps), readFileText(fContacts) ]);
    worker.postMessage({ type:'PROCESS', opsText, contactsText });
  } catch (e) {
    console.error(e);
    showToast('Error leyendo archivos', 3000);
    alert('Error: ' + (e && e.message ? e.message : e));
  }
});

document.getElementById('viewAllBtn').addEventListener('click', () => { App.view='all'; render(); });
document.getElementById('viewActivosBtn').addEventListener('click', () => { App.view='active'; render(); });
document.getElementById('viewNoActivosBtn').addEventListener('click', () => { App.view='inactive'; render(); });

document.getElementById('exportPlanillaBtn').addEventListener('click', () => {
  if (!App.preview || App.preview.length === 0) return showToast('Primero procesá los archivos', 2000);
  const onlyNoAct = document.getElementById('exportOnlyNoActivos').checked;
  const exportMaxRows = parseInt(document.getElementById('limitRows').value, 10) || 0;
  worker.postMessage({ type:'EXPORT_PLANILLA', onlyNoAct, exportMaxRows });
});

document.getElementById('exportWhaticketBtn').addEventListener('click', () => {
  if (!App.preview || App.preview.length === 0) return showToast('Primero procesá los archivos', 2000);
  const exportMaxRows = parseInt(document.getElementById('limitRows').value, 10) || 0;
  worker.postMessage({ type:'EXPORT_WTK', exportMaxRows });
});

/* init */
render();
</script>
</body>
</html>
